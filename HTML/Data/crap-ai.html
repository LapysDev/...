<!DOCTYPE html>
<html>
  <head>
    <!-- Document Title -->
    <title> Crap AI </title>

    <!-- Document Stylesheet -->
    <style media=all type=text/css>
      /* DOM Elements > ... */
      body { margin: 0 }

      body, html {
        height: 100%;
        width: 100%
      }

      /* Features > Render */
      #render {
        border: 1px solid rgba(127, 127, 127, 0.5);
        border: none;
        border-spacing: 0;
        box-sizing: border-box;
        height: inherit;
        vertical-align: top;
        width: inherit
      }
        #render canvas {
          height: 100%;
          position: absolute;
          width: 100%
        }

        #render tbody { vertical-align: inherit }
        #render td { padding: 0 }
    </style>
  </head>

  <body>
    <table id=render> <tbody> <tr> <td> <canvas> </canvas> </td> </tr> </tbody> </table>

    <!-- Document Script -->
    <script language=javascript type=text/javascript>
      /* Constant > ... */
      var AGENT_COUNT  = 10;
      var FONT_SIZE    = 20;
      var GRID_SIZE    = 10;
      var TARGET_COUNT = 2;

      /* Global > ... */
      var canvas      = render.querySelector("canvas");
      var agents      = new Array(AGENT_COUNT);
      var cells       = new Array(GRID_SIZE * GRID_SIZE);
      var context     = canvas.getContext("2d", {alpha: false, desynchronized: false});
      var displayMenu = false;
      var displayView = AGENT_COUNT;
      var pointer     = {active: false, clicked: false, x: -1, y: -1};

      var epochCount     = "undefined" !== typeof BigInt ? BigInt(0) : Number(0);
      var epochDuration  = 30e3;
      var epochTimestamp = 0;
      var simulationDuration  = 1e3;
      var simulationTimestamp = 0;

      /* Enumeration > Cell */
      var Cells = {AGENT: 0, TARGET: 1, UNOCCUPIED: 2};

      /* Class > Cell */
      function Cell(type, biases) {
        this.biases = biases;
        this.score  = 0.0;
        this.type   = type
      }
        Cell.prototype = {
          biases: null,
          score : 0.0,
          type  : Cells.UNOCCUPIED
        };

      /* Event > ... */
      document.body.onmousedown = function() {
        pointer.active = true
      };

      document.body.onmousemove = function(event) {
        var left = 0;
        var top  = 0;

        for (var element = canvas; null !== element; element = element.parentElement) {
          left += element.offsetLeft;
          top  += element.offsetTop
        }

        pointer.x = event.clientX - left;
        pointer.y = event.clientY - top
      };

      document.body.onmouseup = function() {
        pointer.clicked = pointer.active;
        pointer.active = false;
      };

      /* ... */
      void function initiate() {
        for (var index = GRID_SIZE * GRID_SIZE; index; )
        cells[--index] = new Cell(Cells.UNOCCUPIED, []);

        // setup agents & targets
        for (var index = AGENT_COUNT; index; )
        agents[--index] = null;

        for (var count = TARGET_COUNT, index, range = cells.length - 1; count; --count) {
          do index = Math.trunc(range * Math.random());
          while (Cells.TARGET === cells[index].type);

          cells[index].biases = null;
          cells[index].type = Cells.TARGET
        }
      }();

      void function preview() {
        var height = canvas.parentElement.offsetHeight;
        var width  = canvas.parentElement.offsetWidth;
        var size = Math.min(height, width);

        // ...
        canvas.style.height     = (canvas.height = size) + "px";
        canvas.style.marginLeft = (Math.abs(size - width ) / 2) + "px";
        canvas.style.marginTop  = (Math.abs(size - height) / 2) + "px";
        canvas.style.width      = (canvas.width  = size) + "px";

        context.font                  = FONT_SIZE.toPrecision(6) + "px monospace, sans-serif";
        context.imageSmoothingEnabled = false;
        context.imageSmoothingQuality = "low";
        context.textBaseline          = "top";

        // ...
        document.body.onresize = preview
      }();

      void function play(currentTimestamp) {
        var scoredBest    = 0.0;
        var scoredCurrent = ;
        var scoredWorst   = Number.MAX_VALUE;
        var best = 0.0, worst = Number.MAX_VALUE;
        var current = AGENT_COUNT;

        var cellHeight = canvas.height / GRID_SIZE;
        var cellWidth  = canvas.width  / GRID_SIZE;
        var cursor = "default";

        // ...
        for (var index = agents.length; index; ) {
          var agent = agents[--index];

          if (null !== agent) {
            best  = Math.max(best,  agent.score);
            worst = Math.min(worst, agent.score)
          }
        }

        best    = best.toPrecision(3);
        current = ~view ? (null === agents[view] ? "..." : agents[view].score.toPrecision(3)) : best;
        worst   = worst.toPrecision(3);

        // clear the frame
        context.fillStyle = "#000000";
        context.fillRect(0, 0, canvas.width, canvas.height);

        // draw the grid
        context.lineWidth   = 1;
        context.strokeStyle = "rgba(255, 255, 255, 0.675)";

        for (var column = GRID_SIZE; column--; )
        for (var row    = GRID_SIZE; row--; ) {
          var x = cellWidth  * column;
          var y = cellHeight * row;

          // ...
          context.beginPath();
          context.moveTo(x + cellWidth, y + 0);
          context.lineTo(x + cellWidth, y + cellHeight);
          context.lineTo(x + 0,         y + cellHeight);
          context.stroke();
          context.closePath()
        }

        // draw the displayMenu
        context.fillStyle = "rgba(255, 255, 255, 0.25)";

        if ((pointer.x >= 15 && pointer.x <= 15 + context.measureText('☰').width) && (pointer.y >= 15 && pointer.y <= 15 + FONT_SIZE)) {
          context.fillStyle = "rgba(255, 255, 255, 0.65)";

          cursor = "pointer";
          displayMenu   = pointer.clicked !== displayMenu
        }

        context.fillText('☰', 15, 15);
        if (displayMenu) {
          var menuHeight = Math.max(300, canvas.height / 2);
          var menuWidth  = Math.max(200, canvas.width  / 2);

          // ...
          context.fillStyle   = "rgba(0, 0, 0, 0.8)";
          context.lineWidth   = 2;
          context.strokeStyle = "rgba(255, 255, 255, 0.8)";

          context.fillRect  (20, 25 + FONT_SIZE, menuWidth, menuHeight);
          context.strokeRect(20, 25 + FONT_SIZE, menuWidth, menuHeight);

          // ...
          context.fillStyle = "rgba(255, 255, 255, 0.75)";

          context.fillText("Epoch: ",   30, 35 + (FONT_SIZE * 1));
          context.fillText("View :",    30, 45 + (FONT_SIZE * 2));
          context.fillText("BEST   : ", 30, 45 + (FONT_SIZE * 4));
          context.fillText("CURRENT: ", 30, 55 + (FONT_SIZE * 5));
          context.fillText("WORST  : ", 30, 65 + (FONT_SIZE * 6));

          // ...
          context.fillStyle = "rgba(255, 255, 255, 0.55)";

          context.fillText(epochCount.toString(), 30 + context.measureText("Epoch: ").width,   35 + (FONT_SIZE * 1));
          context.fillText(best,                  30 + context.measureText("BEST   : ").width, 45 + (FONT_SIZE * 4));
          context.fillText(current,               30 + context.measureText("CURRENT: ").width, 55 + (FONT_SIZE * 5));
          context.fillText(worst,                 30 + context.measureText("WORST  : ").width, 65 + (FONT_SIZE * 6));

          if (view === -1) {
            context.fillStyle = "rgba(0, 255, 0, 0.75)";
            context.fillText("BEST", 30 + context.measureText("View : ").width, 45 + (FONT_SIZE * 2))
          }

          else if (view === AGENT_COUNT) {
            context.fillStyle = "rgba(0, 255, 0, 0.75)";
            context.fillText("WORST", 30 + context.measureText("View : ").width, 45 + (FONT_SIZE * 2))
          }

          else context.fillText(view, 30 + context.measureText("View :").width, 45 + (FONT_SIZE * 2))
        }

        // ...
        if (epochDuration < currentTimestamp - epochTimestamp || 0 === currentTimestamp) {
          var index;

          epochTimestamp = currentTimestamp;

          // remove the agents
          for (var subindex = AGENT_COUNT; subindex; ) {
            var agent = agents[--subindex];
            if (null !== agent) agent.type = Cells.UNOCCUPIED
          }

          // set the agents
          do index = Math.trunc((cells.length - 1) * Math.random());
          while (Cells.TARGET === cells[index].type);

          cells[index].type = Cells.AGENT;

          for (var subindex = AGENT_COUNT; subindex; )
          agents[--subindex] = cells[index]
        }

        if (simulationDuration < currentTimestamp - simulationTimestamp && currentTimestamp !== epochTimestamp) {
          simulationTimestamp = currentTimestamp;

          for (var index = AGENT_COUNT; index; ) {
            var agent = agents[--index];
          }
        }

        // ...
        canvas.style.cursor = cursor;
        pointer.clicked = false;

        ("undefined" === typeof requestAnimationFrame ? requestAnimationFrame : setTimeout)(play)
      }(0)
    </script>
  </body>
</html>
